name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Minimal permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # Validate markdown files and frontmatter
  validate-structure:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Install markdown linter
        run: npm install -g markdownlint-cli

      - name: Validate markdown syntax
        run: |
          markdownlint '**/*.md' \
            --ignore node_modules \
            --config .markdownlint.json || echo "Warning: Markdown linting found issues"

      - name: Validate agent and workflow metadata
        run: |
          echo "Validating agent frontmatter format..."
          find plugins/orchestr8/agents -name "*.md" 2>/dev/null | while read -r file; do
            # Check for YAML frontmatter delimiters
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "ERROR: $file missing YAML frontmatter"
              exit 1
            fi

            # Validate required fields exist
            if ! grep -q "^name:" "$file"; then
              echo "ERROR: $file missing 'name' field in frontmatter"
              exit 1
            fi

            if ! grep -q "^description:" "$file"; then
              echo "ERROR: $file missing 'description' field in frontmatter"
              exit 1
            fi

            if ! grep -q "^model:" "$file"; then
              echo "ERROR: $file missing 'model' field in frontmatter"
              exit 1
            fi
          done
          echo "✓ All agents have valid YAML frontmatter"

          # Workflow files are plain markdown, no specific format required
          workflow_count=$(find plugins/orchestr8/commands -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
          echo "✓ Found $workflow_count workflow files"

      - name: Validate directory structure
        run: |
          echo "Validating plugin directory structure..."

          # Required directories under plugins/orchestr8/
          required_dirs=(
            "plugins/orchestr8"
            "plugins/orchestr8/agents"
            "plugins/orchestr8/commands"
            "plugins/orchestr8/.claude-plugin"
            ".claude-plugin"
          )

          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "ERROR: Missing required directory: $dir"
              exit 1
            fi
          done

          # Check that agents and commands exist
          agent_count=$(find plugins/orchestr8/agents -name "*.md" | wc -l | tr -d ' ')
          command_count=$(find plugins/orchestr8/commands -name "*.md" | wc -l | tr -d ' ')

          if [ "$agent_count" -eq 0 ]; then
            echo "ERROR: No agents found in plugins/orchestr8/agents/ directory"
            exit 1
          fi

          echo "✓ Directory structure is valid ($agent_count agents, $command_count workflows found)"

      - name: Validate required files
        run: |
          echo "Validating required files..."

          required_files=(
            "VERSION"
            "plugins/orchestr8/.claude-plugin/plugin.json"
            "CHANGELOG.md"
            "plugins/orchestr8/CLAUDE.md"
            ".claude-plugin/marketplace.json"
            "README.md"
            "ARCHITECTURE.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
          done

          # Validate plugin structure
          echo "Validating plugin structure..."
          if [ ! -f "plugins/orchestr8/.claude-plugin/plugin.json" ]; then
            echo "ERROR: Plugin plugin.json missing"
            exit 1
          fi

          # Validate plugin.json has required fields
          if ! jq -e '.name' "plugins/orchestr8/.claude-plugin/plugin.json" > /dev/null 2>&1; then
            echo "ERROR: plugin.json missing 'name' field"
            exit 1
          fi
          echo "✓ Plugin structure valid"

          echo "✓ All required files present"

  # Validate version consistency
  validate-versions:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check version consistency
        run: |
          echo "Checking version consistency across all files..."

          # Read versions from different files
          VERSION_FILE=$(cat VERSION | tr -d '\n')
          PLUGIN_VERSION=$(jq -r '.version' plugins/orchestr8/.claude-plugin/plugin.json)
          MARKETPLACE_META_VERSION=$(jq -r '.metadata.version' .claude-plugin/marketplace.json)
          MARKETPLACE_PLUGIN_VERSION=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)

          echo "VERSION file: $VERSION_FILE"
          echo "plugin.json: $PLUGIN_VERSION"
          echo "marketplace.json (metadata): $MARKETPLACE_META_VERSION"
          echo "marketplace.json (plugins[0]): $MARKETPLACE_PLUGIN_VERSION"

          # Check all versions match
          if [ "$VERSION_FILE" != "$PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch between VERSION ($VERSION_FILE) and plugin.json ($PLUGIN_VERSION)"
            exit 1
          fi

          if [ "$VERSION_FILE" != "$MARKETPLACE_META_VERSION" ]; then
            echo "ERROR: Version mismatch between VERSION ($VERSION_FILE) and marketplace.json metadata ($MARKETPLACE_META_VERSION)"
            exit 1
          fi

          if [ "$VERSION_FILE" != "$MARKETPLACE_PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch between VERSION ($VERSION_FILE) and marketplace.json plugins[0] ($MARKETPLACE_PLUGIN_VERSION)"
            exit 1
          fi

          echo "✓ All version files are consistent: $VERSION_FILE"

      - name: Validate semantic versioning
        run: |
          VERSION=$(cat VERSION | tr -d '\n')

          # Check if version follows semantic versioning (X.Y.Z)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Version '$VERSION' does not follow semantic versioning (MAJOR.MINOR.PATCH)"
            exit 1
          fi

          echo "✓ Version follows semantic versioning: $VERSION"

  # Validate plugin metadata
  validate-metadata:
    name: Validate Plugin Metadata
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate plugin.json
        run: |
          echo "Validating plugin.json structure..."

          # Check required fields
          required_fields=("name" "version" "description" "author" "license" "repository")

          for field in "${required_fields[@]}"; do
            if ! jq -e ".$field" plugins/orchestr8/.claude-plugin/plugin.json > /dev/null; then
              echo "ERROR: Missing required field in plugin.json: $field"
              exit 1
            fi
          done

          echo "✓ plugin.json structure is valid"

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace.json structure..."

          # Check required fields
          if ! jq -e '.name' .claude-plugin/marketplace.json > /dev/null; then
            echo "ERROR: Missing 'name' field in marketplace.json"
            exit 1
          fi

          if ! jq -e '.metadata.version' .claude-plugin/marketplace.json > /dev/null; then
            echo "ERROR: Missing 'metadata.version' field in marketplace.json"
            exit 1
          fi

          if ! jq -e '.plugins[0]' .claude-plugin/marketplace.json > /dev/null; then
            echo "ERROR: Missing plugins array in marketplace.json"
            exit 1
          fi

          echo "✓ marketplace.json structure is valid"

      - name: Validate component counts
        run: |
          echo "Validating agent and workflow counts..."

          # Count actual agents in plugins/orchestr8/agents directory
          AGENT_COUNT=$(find plugins/orchestr8/agents -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

          # Count actual workflows in plugins/orchestr8/commands directory
          WORKFLOW_COUNT=$(find plugins/orchestr8/commands -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

          echo "Detected agents: $AGENT_COUNT"
          echo "Detected workflows: $WORKFLOW_COUNT"

          # Get counts from plugin.json
          PLUGIN_AGENT_COUNT=$(jq -r '.features.agents' plugins/orchestr8/.claude-plugin/plugin.json)
          PLUGIN_WORKFLOW_COUNT=$(jq -r '.features.workflows' plugins/orchestr8/.claude-plugin/plugin.json)

          echo "plugin.json reports: $PLUGIN_AGENT_COUNT agents, $PLUGIN_WORKFLOW_COUNT workflows"

          # Validate counts match
          if [ "$AGENT_COUNT" != "$PLUGIN_AGENT_COUNT" ]; then
            echo "WARNING: Agent count mismatch (found: $AGENT_COUNT, plugin.json: $PLUGIN_AGENT_COUNT)"
          fi

          if [ "$WORKFLOW_COUNT" != "$PLUGIN_WORKFLOW_COUNT" ]; then
            echo "WARNING: Workflow count mismatch (found: $WORKFLOW_COUNT, plugin.json: $PLUGIN_WORKFLOW_COUNT)"
          fi

          echo "✓ Component counts validated"

  # Security scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@fca954587c60352120abcd6c5a6958fc809f575d # main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --only-verified

      - name: Scan for malicious patterns
        run: |
          echo "Scanning for potentially malicious patterns..."

          # Check for common malicious patterns in agent and command directories
          if grep -r "eval(" plugins/orchestr8/agents/ plugins/orchestr8/commands/ --include="*.md" 2>/dev/null; then
            echo "WARNING: Found eval() usage in markdown files"
          fi

          if grep -r "exec(" plugins/orchestr8/agents/ plugins/orchestr8/commands/ --include="*.md" 2>/dev/null; then
            echo "WARNING: Found exec() usage in markdown files"
          fi

          echo "✓ Security scan complete"

  # Link validation
  validate-links:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: Check links in README
        run: |
          markdown-link-check README.md --config .github/markdown-link-check.json || echo "Warning: Some links may be broken"

      - name: Check links in ARCHITECTURE
        run: |
          markdown-link-check ARCHITECTURE.md --config .github/markdown-link-check.json || echo "Warning: Some links may be broken"

  # All checks passed
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      [
        validate-structure,
        validate-versions,
        validate-metadata,
        security-scan,
        validate-links,
      ]
    steps:
      - name: All checks passed
        run: |
          echo "✅ All CI checks passed successfully!"
          echo "The plugin is ready for release."
