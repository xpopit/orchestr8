name: PR Quality Gates

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # PR metadata validation
  pr-validation:
    name: Validate PR Metadata
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Validate PR title
        uses: amannn/action-semantic-pull-request@0723387faaf9b38adef4775cd42cfd5155ed6017 # v5.5.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            refactor
            test
            chore
            release
          requireScope: false

      - name: Check PR description
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            if (!pr.body || pr.body.trim().length === 0) {
              core.setFailed('PR description is required');
              return;
            }

            if (pr.body.trim().length < 20) {
              core.setFailed('PR description is too short (minimum 20 characters)');
              return;
            }

            console.log('‚úì PR description is valid');

  # Check what files changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      agents: ${{ steps.filter.outputs.agents }}
      workflows: ${{ steps.filter.outputs.workflows }}
      docs: ${{ steps.filter.outputs.docs }}
      config: ${{ steps.filter.outputs.config }}
      version: ${{ steps.filter.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v2.12.0
        id: filter
        with:
          filters: |
            agents:
              - 'plugins/orchestr8/agents/**/*.md'
            workflows:
              - 'plugins/orchestr8/commands/**/*.md'
            docs:
              - 'README.md'
              - 'ARCHITECTURE.md'
              - 'CLAUDE.md'
              - 'CHANGELOG.md'
              - 'plugins/orchestr8/CLAUDE.md'
            config:
              - 'plugins/orchestr8/.claude-plugin/plugin.json'
              - '.claude-plugin/marketplace.json'
            version:
              - 'VERSION'
              - 'plugins/orchestr8/.claude-plugin/plugin.json'
              - '.claude-plugin/marketplace.json'

  # Validate new/modified agents
  validate-agents:
    name: Validate Agent Changes
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.agents == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get changed agent files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | \
            grep 'agents/.*\.md$' > changed-agents.txt || true

          if [ -s changed-agents.txt ]; then
            echo "Changed agents:"
            cat changed-agents.txt
          else
            echo "No agent files changed"
          fi

      - name: Validate agent metadata
        run: |
          if [ ! -s changed-agents.txt ]; then
            echo "No agents to validate"
            exit 0
          fi

          echo "Validating changed agents..."

          while IFS= read -r file; do
            echo "Checking $file..."

            # Check for YAML frontmatter delimiters
            if ! head -1 "$file" | grep -q "^---$"; then
              echo "ERROR: $file missing YAML frontmatter"
              exit 1
            fi

            # Validate required fields exist
            if ! grep -q "^name:" "$file"; then
              echo "ERROR: $file missing 'name' field in frontmatter"
              exit 1
            fi

            if ! grep -q "^description:" "$file"; then
              echo "ERROR: $file missing 'description' field in frontmatter"
              exit 1
            fi

            if ! grep -q "^model:" "$file"; then
              echo "ERROR: $file missing 'model' field in frontmatter"
              exit 1
            fi

            echo "‚úì $file is valid"
          done < changed-agents.txt

          echo "‚úì All changed agents are valid"

      - name: Check agent documentation quality
        run: |
          if [ ! -s changed-agents.txt ]; then
            exit 0
          fi

          echo "Checking documentation quality..."

          while IFS= read -r file; do
            # Count lines (excluding frontmatter)
            line_count=$(tail -n +10 "$file" | wc -l)

            if [ "$line_count" -lt 50 ]; then
              echo "WARNING: $file has less than 50 lines of documentation"
            fi

            # Check for code examples (looking for ``` blocks)
            example_count=$(grep -c '```' "$file" || true)

            if [ "$example_count" -lt 2 ]; then
              echo "WARNING: $file has few or no code examples (found $example_count)"
            fi

          done < changed-agents.txt

          echo "‚úì Documentation quality check complete"

  # Validate new/modified workflows
  validate-workflows:
    name: Validate Workflow Changes
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.workflows == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Get changed workflow files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD | \
            grep 'commands/.*\.md$' > changed-workflows.txt || true

          if [ -s changed-workflows.txt ]; then
            echo "Changed workflows:"
            cat changed-workflows.txt
          fi

      - name: Validate workflow files
        run: |
          if [ ! -s changed-workflows.txt ]; then
            echo "No workflows to validate"
            exit 0
          fi

          while IFS= read -r file; do
            echo "Checking $file..."

            # Workflow files are plain markdown, just verify they exist and are not empty
            if [ ! -s "$file" ]; then
              echo "ERROR: $file is empty"
              exit 1
            fi

            echo "‚úì $file is valid"
          done < changed-workflows.txt

          echo "‚úì All changed workflows are valid"

  # Validate version changes
  validate-version-change:
    name: Validate Version Changes
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.version == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check version consistency
        run: |
          echo "Checking version consistency..."

          VERSION_FILE=$(cat VERSION | tr -d '\n')
          PLUGIN_VERSION=$(jq -r '.version' plugins/orchestr8/.claude-plugin/plugin.json)
          MARKETPLACE_META=$(jq -r '.metadata.version' .claude-plugin/marketplace.json)
          MARKETPLACE_PLUGIN=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)

          echo "VERSION file: $VERSION_FILE"
          echo "plugin.json: $PLUGIN_VERSION"
          echo "marketplace.json (metadata): $MARKETPLACE_META"
          echo "marketplace.json (plugins[0]): $MARKETPLACE_PLUGIN"

          errors=0

          if [ "$VERSION_FILE" != "$PLUGIN_VERSION" ]; then
            echo "ERROR: Version mismatch between VERSION and plugin.json"
            errors=$((errors + 1))
          fi

          if [ "$VERSION_FILE" != "$MARKETPLACE_META" ]; then
            echo "ERROR: Version mismatch between VERSION and marketplace.json metadata"
            errors=$((errors + 1))
          fi

          if [ "$VERSION_FILE" != "$MARKETPLACE_PLUGIN" ]; then
            echo "ERROR: Version mismatch between VERSION and marketplace.json plugins[0]"
            errors=$((errors + 1))
          fi

          if [ $errors -gt 0 ]; then
            echo ""
            echo "‚ùå Version consistency check failed!"
            echo "All version files must match. Please update:"
            echo "  - .claude/VERSION"
            echo "  - .claude/plugin.json (version field)"
            echo "  - .claude-plugin/marketplace.json (metadata.version)"
            echo "  - .claude-plugin/marketplace.json (plugins[0].version)"
            exit 1
          fi

          echo "‚úì All version files are consistent"

      - name: Check CHANGELOG updated
        run: |
          VERSION=$(cat VERSION | tr -d '\n')

          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md must have entry for version $VERSION"
            echo "Add: ## [$VERSION] - $(date +%Y-%m-%d)"
            exit 1
          fi

          echo "‚úì CHANGELOG has entry for version $VERSION"

  # Comment on PR with validation results
  pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs:
      [
        pr-validation,
        detect-changes,
        validate-agents,
        validate-workflows,
        validate-version-change,
      ]
    if: always()
    steps:
      - name: Post validation summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const needs = ${{ toJSON(needs) }};
            const allPassed = Object.values(needs).every(job =>
              job.result === 'success' || job.result === 'skipped'
            );

            let comment = '## ü§ñ PR Quality Gates\n\n';

            // PR Validation
            const prValidation = needs['pr-validation'];
            comment += `- ${prValidation.result === 'success' ? '‚úÖ' : '‚ùå'} PR Metadata Validation\n`;

            // Agent validation
            if (needs['detect-changes'].outputs.agents === 'true') {
              const agentValidation = needs['validate-agents'];
              comment += `- ${agentValidation.result === 'success' ? '‚úÖ' : '‚ùå'} Agent Changes Validation\n`;
            }

            // Workflow validation
            if (needs['detect-changes'].outputs.workflows === 'true') {
              const workflowValidation = needs['validate-workflows'];
              comment += `- ${workflowValidation.result === 'success' ? '‚úÖ' : '‚ùå'} Workflow Changes Validation\n`;
            }

            // Version validation
            if (needs['detect-changes'].outputs.version === 'true') {
              const versionValidation = needs['validate-version-change'];
              comment += `- ${versionValidation.result === 'success' ? '‚úÖ' : '‚ùå'} Version Consistency Check\n`;
            }

            comment += '\n';

            if (allPassed) {
              comment += '‚úÖ **All quality gates passed!** This PR is ready for review.\n';
            } else {
              comment += '‚ùå **Some quality gates failed.** Please review the checks above.\n';
            }

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
