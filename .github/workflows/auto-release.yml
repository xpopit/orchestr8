name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - '.claude/VERSION'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-version:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      should_release: ${{ steps.check.outputs.should_release }}
      commit_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(cat .claude/VERSION | tr -d '\n')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version file: $NEW_VERSION"

      - name: Get latest release version
        id: latest
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST#v}
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST_VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"

          if [ "$NEW_VERSION" != "$LATEST_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "✓ Version changed from $LATEST_VERSION to $NEW_VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($NEW_VERSION) - skipping release"
          fi

  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect-version.outputs.commit_sha }}

      - name: Configure git
        run: |
          git config --global user.email "noreply@anthropic.com"
          git config --global user.name "Claude Code"

      - name: Create and push git tag
        env:
          VERSION: ${{ needs.detect-version.outputs.version }}
        run: |
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          echo "✓ Tag v${VERSION} created and pushed"

  wait-for-builds:
    name: Wait for Binary Builds
    runs-on: ubuntu-latest
    needs: [detect-version, create-tag]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Wait for Release Cross-Platform Binaries workflow
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "Waiting for binary builds for tag: $VERSION"

          # Wait up to 45 minutes for workflow to complete
          for i in {1..90}; do
            echo "Check $i/90 (waiting up to 45 minutes)..."

            # Get all workflow runs for this tag
            RUNS=$(gh run list --workflow=release-binaries.yml --json status,conclusion,headBranch,name --limit 20 2>/dev/null | \
              jq -r ".[] | select(.headBranch == \"$VERSION\" or .name | contains(\"$VERSION\")) | .status")

            if [ ! -z "$RUNS" ]; then
              # Check if any are still in_progress
              IN_PROGRESS=$(echo "$RUNS" | grep -c "in_progress" || true)

              if [ "$IN_PROGRESS" -eq 0 ]; then
                echo "✓ All binary builds completed"

                # Get the results
                RESULTS=$(gh run list --workflow=release-binaries.yml --json conclusion --limit 20 2>/dev/null | \
                  jq -r '.[] | .conclusion' | head -1)

                if [ "$RESULTS" = "success" ]; then
                  echo "✓ Binary builds succeeded"
                  exit 0
                else
                  echo "✗ Binary builds failed or were cancelled"
                  exit 1
                fi
              fi
            fi

            sleep 30
          done

          echo "✗ Timeout waiting for binary builds (45 minutes exceeded)"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize-release:
    name: Finalize GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-version, wait-for-builds]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for release workflow to complete
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "Waiting for Release workflow for tag: $VERSION"

          # Wait up to 10 minutes for release.yml to complete
          for i in {1..20}; do
            RELEASE=$(gh release view "$VERSION" 2>/dev/null || echo "not-found")

            if [ "$RELEASE" != "not-found" ]; then
              echo "✓ GitHub release $VERSION is now live"
              exit 0
            fi

            echo "Release not yet available, waiting..."
            sleep 30
          done

          echo "Note: Release may still be processing"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "✓ Release process complete for $VERSION"
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
