name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - '.claude/VERSION'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-version:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(cat .claude/VERSION | tr -d '\n')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version file: $NEW_VERSION"

      - name: Get latest release version
        id: latest
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST#v}
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST_VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"

          if [ "$NEW_VERSION" != "$LATEST_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Version changed from $LATEST_VERSION to $NEW_VERSION - triggering release"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($NEW_VERSION) - skipping release"
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create git tag
        env:
          VERSION: ${{ needs.check-version.outputs.version }}
        run: |
          git tag -a "v${VERSION}" -m "Release v${VERSION}" || true
          git push origin "v${VERSION}" || true

      - name: Trigger release workflow
        run: |
          gh workflow run release.yml -f tag=v${{ needs.check-version.outputs.version }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for release workflow
        run: |
          for i in {1..60}; do
            WORKFLOW_ID=$(gh run list --workflow=release.yml --limit 1 --json databaseId --jq '.[0].databaseId' 2>/dev/null)
            if [ ! -z "$WORKFLOW_ID" ]; then
              echo "Release workflow started: $WORKFLOW_ID"
              exit 0
            fi
            echo "Waiting for workflow to start..."
            sleep 5
          done
          echo "Workflow did not start within timeout"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
